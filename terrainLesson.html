<!DOCTYPE html>
<html>
<head>
    <title>Terrain</title>
    <script src="js/lib/jquery-1.11.2.min.js"></script>

    <script src="js/spqr.js"></script>
    <script src="js/context.js"></script>
    <script src="js/basicTypes.js"></script>
    <script src="js/state.js"></script>
    <script src="js/engine.js"></script>
    <script src="js/resources.js"></script>
    <script src="js/scene.js"></script>
    <script src="js/terrain.js"></script>
    <script src="js/render.js"></script>
    <script src="js/inputManager.js"></script>
    <script src="js/eventsManager.js"></script>

    <script src="js/terrainLesson.js"></script>

    <script type="text/javascript">

        function init()
        {
            var canvas = document.getElementById("canvas");
            var context = canvas.getContext("2d");
            var resources = new spqr.ResourceManager();
            var renderer = new spqr.RenderManager(context, canvas.width, canvas.height);
            var engine = new spqr.Engine();

            spqr.Context.resources = resources;
            spqr.Context.renderer = renderer;
            spqr.Context.engine = engine;
            spqr.Context.tileWidth = 50;
            spqr.Context.tileHeight = 50;
            spqr.Context.tileAltitude = 50;

            var td = {
                tiles:
                        [
                            [1, 1, 1, 2, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [2, 1, 1, 2, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1]
                        ],
                heightMap:
                        [
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0]
                        ],
                tileTypes:
                {
                    "1": {image: "terrain.grass", offsetX: spqr.Context.tileWidth, offsetY: 0},
                    "2": {image: "terrain.hole", offsetX: spqr.Context.tileHeight, offsetY: 0},
                    "3": {image: "terrain.chair"},
                    "4": {color: [0, 0, 255, 0]},
                    "5": {}
                },
                tileWidth: spqr.Context.tileWidth,
                tileHeight: spqr.Context.tileHeight
            };

            var td2 = {
                tiles: [],
                heightMap: td.heightMap,
                tileTypes: td.tileTypes,
                tileWidth: td.tileWidth,
                tileHeight: td.tileHeight
            };

            for(var i = 0, l = td.length; i < l; i++)
            {
                var row = td.tiles[i];
                var rowCopy = [];
                for(var j = 0, k = row.length; j < k; j++)
                {
                    rowCopy.push(4);
                }
                td2.tiles.push(rowCopy);
            }

            resources.loadImages({
                "terrain.grass": "img/1-grass-1.png",
                "terrain.hole": "img/hole.png",
                "objects.chair": "img/2-chair1.png"
            }).then(function()
                    {
                        run(td, td2);
                    });
        }

        function customHeart(callback)
        {
            window.heartBeat = callback;
        }

        function run(td, td2)
        {
            var scene = new spqr.Scene.Manager();
            scene.addTerrain("main", td);
            scene.addTerrain("mesh", td2);

            scene.setAction("state.push", function(e)
            {
                window.startDate = Date.now();
                console.log("state.push: " + e.stateName);
            });

            scene.setAction("state.pop", function(e)
            {
                console.log("state.pop: " + e.stateName + " " + (Date.now() - window.startDate));
                console.log("current state: " + spqr.Context.getScene().getEntity("chair").stateMachine.stacks["main"].states[0].name);
            });

            var fpsNode = document.getElementById("FPS");
            scene.setAction("fps.updated", function()
            {
                fpsNode.innerText = "FPS: " + spqr.Context.engine.currentFPS;
            });

            {
                var chair = new spqr.Scene.SpriteEntity(
                        new spqr.Basic.Texture(spqr.Context.resources.images["objects.chair"], spqr.Context.tileWidth, spqr.Context.tileHeight),
                        new spqr.Basic.Box(40, 40, 35));
                chair.setTranslation(new spqr.Basic.Point3D(100, 100, 0));

                var stack = chair.stateMachine.registerStack("main");
                stack.push(new spqr.TerrainLesson.IdleState(chair));

                scene.addEntity("chair", chair);
            }

            spqr.Context.engine.setActiveScene(scene);
            //spqr.Context.engine.setHeart(customHeart);
            spqr.Context.engine.run();
        }
    </script>
</head>
<body onload="init()">
    <canvas id="canvas" width="800" height="400"></canvas>
    <div id="FPS"></div>
</body>
</html>