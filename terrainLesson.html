<!DOCTYPE html>
<html>
<head>
    <title>Terrain</title>
    <script src="js/lib/jquery-1.11.2.min.js"></script>

    <script src="js/spqr.js"></script>
    <script src="js/basicTypes.js"></script>
    <script src="js/engine.js"></script>
    <script src="js/resources.js"></script>
    <script src="js/scene.js"></script>
    <script src="js/terrain.js"></script>
    <script src="js/render.js"></script>
    <script src="js/inputManager.js"></script>

    <script type="text/javascript">

        function init()
        {
            var canvas = document.getElementById("canvas");
            var context = canvas.getContext("2d");
            var resources = new spqr.ResourceManager();
            var renderer = new spqr.RenderManager(context, canvas.width, canvas.height);

            var td = {
                tiles:
                        [
                            [1, 1, 1, 2, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [2, 1, 1, 2, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1]
                        ],
                heightMap:
                        [
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0],
                            [0, 0, 0, 0, 0, 0, 0, 0]
                        ],
                tileTypes:
                {
                    "1": {image: "terrain.grass", offsetX: 50, offsetY: 0},
                    "2": {image: "terrain.hole", offsetX: 50, offsetY: 0},
                    "3": {image: "terrain.chair"},
                    "4": {color: [0, 0, 255, 0]},
                    "5": {}
                },
                tileWidth: 50,
                tileHeight: 50
            }

            var td2 = {
                tiles: [],
                heightMap: td.heightMap,
                tileTypes: td.tileTypes,
                tileWidth: td.tileWidth,
                tileHeight: td.tileHeight
            };

            for(var i = 0, l = td; i < l; i++)
            {
                var row = td.tiles[i];
                var rowCopy = [];
                for(var j = 0, k = row.length; j < k; j++)
                {
                    rowCopy.push(4);
                }
                td2.tiles.push(rowCopy);
            }

            resources.loadImages({
                "terrain.grass": "img/1-grass-1.png",
                "terrain.hole": "img/hole.png",
                "objects.chair": "img/2-chair1.png"
            }).then(function()
                    {
                        run(resources, renderer, td, td2);
                    });
        }

        function run(resources, renderer, td, td2)
        {
            var scene = new spqr.Scene.Manager(renderer, resources);
            scene.addTerrain("main", td);
            scene.addTerrain("mesh", td2);

            var sprite = new spqr.Scene.SpriteEntity(
                    new spqr.Basic.Texture(resources.images["objects.chair"], 50, 50),
                    new spqr.Basic.Box(40, 40, 35));
            sprite.setTranslation(new spqr.Basic.Point3D(100, 100, 0));
            scene.addEntity("chair", sprite);

            scene.setAction("keypress.up", function()
            {
                sprite.move(0, -50, 0);
            });

            scene.setAction("keypress.down", function()
            {
                sprite.move(0, 50, 0);
            });

            scene.setAction("keypress.left", function()
            {
                sprite.move(-50, 0, 0);
            });

            scene.setAction("keypress.right", function()
            {
                sprite.move(50, 0, 0);
            });

            var inputManager = new spqr.InputManager();
            inputManager.subscribe();
            var engine = new spqr.Engine(inputManager);
            engine.setActiveScene(scene);

            engine.run();
        }
    </script>
</head>
<body onload="init()">
    <canvas id="canvas" width="800" height="400"></canvas>
</body>
</html>